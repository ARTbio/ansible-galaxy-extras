<?xml version="1.0"?>
{% import "macros.xml.j2" as macros with context %}
<job_conf>
    <plugins workers="2">
{% if galaxy_extras_config_slurm %}
        <plugin id="slurm" type="runner" load="galaxy.jobs.runners.slurm:SlurmJobRunner">
            <param id="drmaa_library_path">/usr/lib/slurm-drmaa/lib/libdrmaa.so</param>
{% if galaxy_minimum_version >= "17.09" %}
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_SLURM">true</param>
{% endif %}
        </plugin>
{% endif %}
{% if galaxy_extras_config_condor %}
        <plugin id="condor" type="runner" load="galaxy.jobs.runners.condor:CondorJobRunner">
{% if galaxy_minimum_version >= "17.09" %}
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_CONDOR">true</param>
{% endif %}
        </plugin>
{% endif %}
{% if galaxy_extras_config_pbs %}
        <plugin id="pbs" type="runner" load="galaxy.jobs.runners.drmaa:DRMAAJobRunner">
            <param id="drmaa_library_path">/usr/lib/pbs-drmaa/lib/libdrmaa.so.1</param>
{% if galaxy_minimum_version >= "17.09" %}
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_PBS">true</param>
{% endif %}
        </plugin>
{% endif %}
{% if galaxy_extras_config_k8_jobs %}
        <plugin id="k8" type="runner" load="galaxy.jobs.runners.kubernetes:KubernetesJobRunner">
            <!-- We are inside of Kubernetes so use this. -->
            <param id="k8s_use_service_account">true</param>
            <param id="k8s_persistent_volume_claim_name">galaxy-web-claim0</param>
            <param id="k8s_persistent_volume_claim_mount_path">/export</param>
{% if galaxy_minimum_version >= "17.09" %}
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_K8">true</param>
{% endif %}
        </plugin>
{% endif %}
        <plugin id="local" type="runner" load="galaxy.jobs.runners.local:LocalJobRunner"/>
    </plugins>
    <!-- The default handler can be changed by specifying the GALAXY_HANDLERS_DEFAULT environment variable. -->
    <handlers default_from_environ="GALAXY_HANDLERS_DEFAULT" default="handlers">
{% if galaxy_handler_processes == 0 %}
        <handler id="web0" tags="handlers"/>
{% else %}
  {% for i in range(galaxy_handler_processes) %}
        <handler id="handler{{ i }}" tags="handlers"/>
  {% endfor %}
{% endif %}
    </handlers>
    <!-- The default destination can be changed by specifying the GALAXY_DESTINATIONS_DEFAULT environment variable. -->
    <destinations default_from_environ="GALAXY_DESTINATIONS_DEFAULT" default="{{ galaxy_extras_galaxy_destination_default }}">
        <destination id="docker_dispatch" runner="dynamic">
            <!-- Allow different default destinations based on whether the tool
                 supports Docker or not. -->
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id" from_environ="GALAXY_DESTINATIONS_DOCKER_DEFAULT">{{ galaxy_extras_galaxy_destination_docker_default }}</param>
            <param id="default_destination_id" from_environ="GALAXY_DESTINATIONS_NO_DOCKER_DEFAULT">{{ galaxy_extras_galaxy_destination_default }}</param>
        </destination>
        <destination id="local_no_container" runner="local">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
        </destination>
        <destination id="local_docker" runner="local">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled() }}
        </destination>
        <destination id="local_force_docker" runner="local">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled(True) }}
        </destination>
        <destination id="local_docker_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">local_docker</param>
            <param id="default_destination_id">local_no_docker</param>
        </destination>
{% if galaxy_extras_config_slurm or galaxy_extras_config_pbs or galaxy_extras_config_condor %}
  {% if galaxy_extras_config_pbs %}
        <destination id="pbs_cluster" runner="pbs">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_PBS">true</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
        </destination>
        <destination id="pbs_cluster_docker" runner="pbs">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_PBS">true</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled() }}
        </destination>
        <destination id="pbs_cluster_force_docker" runner="pbs">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_PBS">true</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled(True) }}
        </destination>
        <!--
        <destination id="pbs_docker_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">pbs_cluster_docker</param>
            <param id="default_destination_id">pbs_cluster</param>
        </destination>
    -->
 {% endif %}
  {% if galaxy_extras_config_slurm %}
        <destination id="slurm_cluster" runner="slurm">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_SLURM">true</param>
            <param id="nativeSpecification" from_environ="NATIVE_SPEC">--ntasks={{ galaxy_extras_slurm_ntask }} --share</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
        </destination>
        <destination id="slurm_cluster_docker" runner="slurm">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_SLURM">true</param>
            <param id="nativeSpecification" from_environ="NATIVE_SPEC">--ntasks={{ galaxy_extras_slurm_ntask }} --share</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled() }}
        </destination>
        <destination id="slurm_cluster_force_docker" runner="slurm">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_SLURM">true</param>
            <param id="nativeSpecification" from_environ="NATIVE_SPEC">--ntasks={{ galaxy_extras_slurm_ntask }} --share</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            {{ macros.docker_enabled(True) }}
        </destination>
        <!--
        <destination id="slurm_docker_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">slurm_cluster_docker</param>
            <param id="default_destination_id">slurm_cluster</param>
        </destination>
        -->
  {% endif %}
  {% if galaxy_extras_config_condor %}
        <destination id="condor_cluster" runner="condor">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_CONDOR">true</param>
            <param id="universe" from_environ="GALAXY_CONDOR_UNIVERSE">vanilla</param>
        </destination>
        <destination id="condor_cluster_docker" runner="condor">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            <param id="universe" from_environ="GALAXY_CONDOR_UNIVERSE">vanilla</param>
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_CONDOR">true</param>
            {{ macros.docker_enabled() }}
        </destination>
        <destination id="condor_cluster_force_docker" runner="condor">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            <param id="universe" from_environ="GALAXY_CONDOR_UNIVERSE">vanilla</param>
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_CONDOR">true</param>
            {{ macros.docker_enabled(True) }}
        </destination>
        <destination id="condor_docker_universe" runner="condor">
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            <param id="universe" from_environ="GALAXY_CONDOR_UNIVERSE">docker</param>
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_CONDOR">true</param>
            {{ macros.docker_enabled(True) }}
        </destination>
        <!-- Following destinations send to basic Condor runner if no Docker image is available
             otherwise they both use the Docker image - the first submits a normal Condor job
             that will run Docker on the resulting worker node and the second uses Condor's
             native Docker universe support.
        -->
        <destination id="condor_docker_cluster_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">condor_cluster_docker</param>
            <param id="default_destination_id">condor_cluster</param>
        </destination>
        <destination id="condor_docker_universe_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">condor_docker_universe</param>
            <param id="default_destination_id">condor_cluster</param>
        </destination>
  {% endif %}
  {% if galaxy_extras_config_k8_jobs %}
        <destination id="k8_default" runner="k8">
            <param id="enabled" from_environ="GALAXY_RUNNERS_ENABLE_K8">true</param>
            <!-- Following parameter must be set to True for this runner. -->
            <param id="docker_enabled">true</param>
            <env file="{{ galaxy_venv_dir }}/bin/activate"/>
            <param id="docker_default_container_id" from_environ="GALAXY_DOCKER_DEFAULT_CONTAINER">{{ galaxy_docker_default_image }}</param>
        </destination>
        <destination id="k8_or_local_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">k8_default</param>
            <param id="default_destination_id">local_no_docker</param>
        </destination>
        <destination id="k8_or_slurm_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">k8_default</param>
            <param id="default_destination_id">slurm_cluster</param>
        </destination>
        <destination id="k8_or_condor_dispatch" runner="dynamic">
            <param id="type">docker_dispatch</param>
            <param id="docker_destination_id">k8_default</param>
            <param id="default_destination_id">condor_cluster</param>
        </destination>
  {% endif %}

{% endif %}
    </destinations>
    <limits>
    </limits>
</job_conf>
